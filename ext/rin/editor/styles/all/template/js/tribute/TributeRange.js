"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),TributeRange=function(){function e(t){_classCallCheck(this,e),this.tribute=t,this.tribute.range=this}return _createClass(e,[{key:"getDocument",value:function(){var e=void 0;return this.tribute.current.collection&&(e=this.tribute.current.collection.iframe),e?e.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(e){var t=this,n=this.tribute.current,i=void 0,o=this.getTriggerInfo(!1,!1,!0,this.tribute.allowSpaces);if(void 0!==o){if(!this.tribute.positionMenu)return void(this.tribute.menu.style.cssText="display: block;");i=this.isContentEditable(n.element)?this.getContentEditableCaretPosition(o.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.getDocument().activeElement,o.mentionPosition),this.tribute.menu.style.cssText="top: "+i.top+"px;\n                                     left: "+i.left+"px;\n                                     right: "+i.right+"px;\n                                     bottom: "+i.bottom+"px;\n                                     position: absolute;\n                                     zIndex: 10000;\n                                     display: block;","auto"===i.left&&(this.tribute.menu.style.left="auto"),"auto"===i.top&&(this.tribute.menu.style.top="auto"),e&&this.scrollIntoView(),window.setTimeout(function(){var n={width:t.tribute.menu.offsetWidth,height:t.tribute.menu.offsetHeight},o=t.isMenuOffScreen(i,n);(o.horizontally||o.vertically)&&(t.tribute.menu.style.cssText="display: none",t.positionMenuAtCaret(e))},0)}else this.tribute.menu.style.cssText="display: none"}},{key:"selectElement",value:function(e,t,n){var i=void 0,o=e;if(t)for(var r=0;r<t.length;r++){if(void 0===(o=o.childNodes[t[r]]))return;for(;o.length<n;)n-=o.length,o=o.nextSibling;0!==o.childNodes.length||o.length||(o=o.previousSibling)}var l=this.getWindowSelection();(i=this.getDocument().createRange()).setStart(o,n),i.setEnd(o,n),i.collapse(!0);try{l.removeAllRanges()}catch(e){}l.addRange(i),e.focus()}},{key:"resetSelection",value:function(e,t,n){this.isContentEditable(e)?this.selectElement(e,t,n):e!==this.getDocument().activeElement&&e.focus()}},{key:"replaceTriggerText",value:function(e,t,n,i,o){var r=this.tribute.current,l=this.getTriggerInfo(!0,n,t,this.tribute.allowSpaces),s=new CustomEvent("tribute-replaced",{detail:{item:o,event:i}});if(void 0!==l){if(this.isContentEditable(r.element))e+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ",this.pasteHtml(e,l.mentionPosition,l.mentionPosition+l.mentionText.length+1);else{var a=this.getDocument().activeElement,u="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";e+=u;var d=l.mentionPosition,c=l.mentionPosition+l.mentionText.length+u.length;a.value=a.value.substring(0,d)+e+a.value.substring(c,a.value.length),a.selectionStart=d+e.length,a.selectionEnd=d+e.length}r.element.dispatchEvent(s)}}},{key:"pasteHtml",value:function(e,t,n){var i=void 0,o=void 0;o=this.getWindowSelection(),(i=this.getDocument().createRange()).setStart(o.anchorNode,t),i.setEnd(o.anchorNode,n),i.deleteContents();var r=this.getDocument().createElement("div");r.innerHTML=e;for(var l=this.getDocument().createDocumentFragment(),s=void 0,a=void 0;s=r.firstChild;)a=l.appendChild(s);i.insertNode(l),a&&((i=i.cloneRange()).setStartAfter(a),i.collapse(!0),o.removeAllRanges(),o.addRange(i))}},{key:"getWindowSelection",value:function(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}},{key:"getNodePositionInParent",value:function(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++)if(e.parentNode.childNodes[t]===e)return t}},{key:"getContentEditableSelectedPath",value:function(e){var t=this.getWindowSelection(),n=t.anchorNode,i=[],o=void 0;if(null!=n){for(var r=void 0,l=n.contentEditable;null!==n&&"true"!==l;)r=this.getNodePositionInParent(n),i.push(r),null!==(n=n.parentNode)&&(l=n.contentEditable);return i.reverse(),o=t.getRangeAt(0).startOffset,{selected:n,path:i,offset:o}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var e=this.tribute.current,t="";if(this.isContentEditable(e.element)){var n=this.getWindowSelection().anchorNode;if(null!=n){var i=n.textContent,o=this.getWindowSelection().getRangeAt(0).startOffset;i&&o>=0&&(t=i.substring(0,o))}}else{var r=this.tribute.current.element;if(r){var l=r.selectionStart;r.value&&l>=0&&(t=r.value.substring(0,l))}}return t}},{key:"getTriggerInfo",value:function(e,t,n,i){var o=this,r=this.tribute.current,l=void 0,s=void 0,a=void 0;if(this.isContentEditable(r.element)){var u=this.getContentEditableSelectedPath(r);u&&(l=u.selected,s=u.path,a=u.offset)}else l=this.getDocument().activeElement;var d=this.getTextPrecedingCurrentSelection();if(void 0!==d&&null!==d){var c=-1,h=void 0;if(this.tribute.collection.forEach(function(e){var t=e.trigger,i=e.requireLeadingSpace?o.lastIndexWithLeadingSpace(d,t):d.lastIndexOf(t);i>c&&(c=i,h=t,n=e.requireLeadingSpace)}),c>=0&&(0===c||!n||/[\xA0\s]/g.test(d.substring(c-1,c)))){var f=d.substring(c+1,d.length);h=d.substring(c,c+1);var g=f.substring(0,1),p=f.length>0&&(" "===g||" "===g);t&&(f=f.trim());var v=i?/[^\S ]/g:/[\xA0\s]/g;if(!p&&(e||!v.test(f)))return{mentionPosition:c,mentionText:f,mentionSelectedElement:l,mentionSelectedPath:s,mentionSelectedOffset:a,mentionTriggerChar:h}}}}},{key:"lastIndexWithLeadingSpace",value:function(e,t){for(var n=e.split("").reverse().join(""),i=-1,o=0,r=e.length;r>o;o++){var l=o===e.length-1,s=/\s/.test(n[o+1]);if(t===n[o]&&(l||s)){i=e.length-1-o;break}}return i}},{key:"isContentEditable",value:function(e){return"INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName}},{key:"isMenuOffScreen",value:function(e,t){var n=t.width+e.left,i=t.height+e.top,o=window.innerWidth,r=window.innerHeight,l=document.documentElement,s=(window.pageXOffset||l.scrollLeft)-(l.clientLeft||0),a=(window.pageYOffset||l.scrollTop)-(l.clientTop||0);return{horizontally:Math.ceil(n-s)>=o,vertically:Math.ceil(i-a)>=r}}},{key:"getMenuDimensions",value:function(){var e={width:null,height:null};return this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 zIndex: 10000;\n                                 display: block;\n                                 visibility; hidden;",e.width=this.tribute.menu.offsetWidth,e.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",e}},{key:"getTextAreaOrInputUnderlinePosition",value:function(e,t,n){var i=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"],o=null!==window.mozInnerScreenX,r=this.getDocument().createElement("div");r.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(r);var l=r.style,s=window.getComputedStyle?getComputedStyle(e):e.currentStyle;l.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(l.wordWrap="break-word"),l.position="absolute",l.visibility="hidden",i.forEach(function(e){l[e]=s[e]}),o?(l.width=parseInt(s.width)-2+"px",e.scrollHeight>parseInt(s.height)&&(l.overflowY="scroll")):l.overflow="hidden",r.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(r.textContent=r.textContent.replace(/\s/g," "));var a=this.getDocument().createElement("span");a.textContent=e.value.substring(t)||".",r.appendChild(a);var u=e.getBoundingClientRect(),d=document.documentElement,c=(window.pageXOffset||d.scrollLeft)-(d.clientLeft||0),h=(window.pageYOffset||d.scrollTop)-(d.clientTop||0),f={top:u.top+h+a.offsetTop+parseInt(s.borderTopWidth)+parseInt(s.fontSize)-e.scrollTop,left:u.left+c+a.offsetLeft+parseInt(s.borderLeftWidth)},g=window.innerWidth,p=window.innerHeight,v=this.getMenuDimensions(),m=this.isMenuOffScreen(f,v);m.horizontally&&(f.right=g-f.left,f.left="auto");var b=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(m.vertically){var w=b-(p-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);f.bottom=w+(p-u.top-a.offsetTop),f.top="auto"}return this.getDocument().body.removeChild(r),f}},{key:"getContentEditableCaretPosition",value:function(e){var t=void 0,n="sel_"+(new Date).getTime()+"_"+(""+Math.random()).substr(2),i=void 0,o=this.getWindowSelection(),r=o.getRangeAt(0);(i=this.getDocument().createRange()).setStart(o.anchorNode,e),i.setEnd(o.anchorNode,e),i.collapse(!1),(t=this.getDocument().createElement("span")).id=n,t.appendChild(this.getDocument().createTextNode("\ufeff")),i.insertNode(t),o.removeAllRanges(),o.addRange(r);var l=t.getBoundingClientRect(),s=document.documentElement,a=(window.pageXOffset||s.scrollLeft)-(s.clientLeft||0),u=(window.pageYOffset||s.scrollTop)-(s.clientTop||0),d={left:l.left+a,top:l.top+t.offsetHeight+u},c=window.innerWidth,h=window.innerHeight,f=this.getMenuDimensions(),g=this.isMenuOffScreen(d,f);g.horizontally&&(d.left="auto",d.right=c-l.left-a);var p=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(g.vertically){var v=p-(h-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);a=(window.pageXOffset||s.scrollLeft)-(s.clientLeft||0),u=(window.pageYOffset||s.scrollTop)-(s.clientTop||0),d.top="auto",d.bottom=v+(h-l.top)}return t.parentNode.removeChild(t),d}},{key:"scrollIntoView",value:function(e){var t=void 0,n=this.menu;if(void 0!==n){for(;void 0===t||0===t.height;)if(0===(t=n.getBoundingClientRect()).height&&(void 0===(n=n.childNodes[0])||!n.getBoundingClientRect))return;var i=t.top,o=i+t.height;if(0>i)window.scrollTo(0,window.pageYOffset+t.top-20);else if(o>window.innerHeight){var r=window.pageYOffset+t.top-20;r-window.pageYOffset>100&&(r=window.pageYOffset+100);var l=window.pageYOffset-(window.innerHeight-o);l>r&&(l=r),window.scrollTo(0,l)}}}}]),e}();exports.default=TributeRange,module.exports=exports.default;